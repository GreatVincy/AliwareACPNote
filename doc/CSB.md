## 概念
+ 名词解释：云服务总线(Cloud Service Bus)
+ 面向对象：专有云和专有域
+ 实现目标：帮助企业在自己的多个系统之间, 或者与合作伙伴以及第三方的系统之间实现跨系统跨协议的服务能力互通

## 功能示意
1. 企业内部不同架构平台的服务之间通过CSB实现互通
2. 企业内部服务开放给外部, 允许通过CSB以不同的协议同时访问
3. 企业内部通过CSB访问外部以不同协议提供的服务
4. 外部不同架构平台的服务之间通过CSB实现互通

## 产品功能
1. API服务总线
  + 协议转换(HTTP/HSF/Dubbo/Web Service)
  + 认证鉴权(接入企业账号体系)
  + 服务控制(流量控制)

2. API管理组织
  + 服务发布(版本管理, API分类)
  + 服务授权(粒度、可见域)
  + 服务消费(调用SDK、消费计量、限量)

3. API运维监控
  + 平台日志(消费、管理、监控日志)
  + 平台监控(展示、巡检、报警)
  + 平台配置(实例、用户、用户组、角色权限管理)

## 产品优势
  - 高性能稳定可靠
  - 轻量级简便易用
  - 跨协议开放互联
  - 一站式服务管理

## 应用场景
> 云服务总线CSB可以应用于**专有云、公共云, 以及混合云**场景, 实现跨系统跨协议的服务互通;主要针对需要进行管理和控制, 包括安全授权、流量限制的系统间服务访问和对外开放场景;

> 云服务总线CSB注重互联网场景下的开放性;越来越多的情况下, 服务的提供方要面对的是更不确定、更广泛的服务消费用户群, 需要针对性地强调互通开放管理以及便捷的线性扩容能力, 而不是仅仅实现协议转换或者确定目标的以及限定用量的上下游系统之间的集成打通;

  - 内部互通
    1. 一个域的应用通过另一个域的CSB实例访问其内部应用服务
    2. 两个域的CSB实例构成的桥接通道实现互通
    3. 各个域之间通过企业统一的CSB实例实现互通

  - 内外互通
    1. 企业内部以及合作伙伴和第三方都可以在CSB上开放订购服务
    2. 各自的服务通过授权做访问控制(包括流量控制等)
    3. 所有开放的服务在CSB上形成由企业自主管理的综合服务集市

  - 混合云、多群组
    1. 企业内部某个CSB与其在公共云上的某个VPC内的CSB通过专线互通
    2. 公共云上的多个企业VPC之间通过各自的CSB互通
    3. 每个CSB(实例)上的用户和服务由CSB实例拥有者自主管理

## 名词解释
| 名词          | 解释          |
|:------------- |:------------- |
| API消费方应用 | 指直接调用CSB上开放的服务API的消费者应用 |
| API消费方应用 | 即代表API消费方应用在CSB上订购服务和管理订购的用户 |
|  API消费凭证  | API消费方应用需要使用API消费凭证(简称凭证)来调用CSB上开放的服务API;API消费者使用凭证来订购API;凭证具体表现为一对AccessKey和SecretKey, 通常简称AK/SK, 在API调用时用来做签名信息计算, CSB接收到API调用请求时对签名信息做验证;API消费者可以创建多个API消费凭证, 每个凭证可被一个或一组API消费方应用使用, 通常可以把凭证作为API消费方应用的分组 |  
| API提供方应用 | 和消费方相对, 指接入CSB开放出服务API的提供者应用 |  
|   API发布者   | 即API提供方应用在CSB上发布服务和管理服务的代表;体现为开放平台上具有发布者角色的账号    |  
|    CSB实例    | 每一组CSB服务总线节点(Broker)集群被视为一个独立的CSB实例, 通常负责一个业务域内能力的对外开放, 也可以把外部的能力发布开放给业务域的内部 |  
|    CSB群组    | 一个CSB群组就是多个CSB实例的集合, 这些CSB实例通过同一个CSB管理中心管理, 使用同一套用户账号系统;如何界定群组的边界取决于实际业务需求以及网络拓扑限制, 而其中CSB管控中心与CSB实例的部署模式也应根据具体网络拓扑限制确定 |  
|    服务接入   | 对CSB来说, 或者说将服务接入到CSB上, 指的是在CSB上注册这个服务并且提供足够的信息让CSB可以访问这个已有的服务;例如要接入一个RESTful服务, 需要提供这个服务的基础URL或称端点, 要使用的HTTP方法等信息 |  
|    服务开放   | 对CSB来说, 服务在CSB上开放就是把一个已接入的服务在某个CSB上提供对应的API调用入口, 可以用各种协议(包括原协议)来访问这个服务API;注意API的发布都在特定CSB实例上 |  
|    服务授权   | API的发布者赋予API消费方应用使用指定API消费凭证来调用某个API 的权限, 就是授权;授权除了定性的允许、禁止之外, 还可以包含更广泛的限制如访问频度控制、优先级等等 |
|     服务组    |  服务组(API组)是业务上的原子粒度分组, 每一个API都归属且仅归属一个API组;也就是说, 在发布新的API时, 必须指定其所属的服务组;API组在API数量少时可视作简单分类, 在数量多时通常需要更多层次结构的分类目录树, 这个特性将在后续版本推出 |

## 公测开通指南
1. 申请开通 CSB 公测资格
2. 提交 CSB 实例创建申请
3. 准备 ECS 主机资源（杭州机器，建议 2 核 4G 内存的 ECS）
4. 实例部署激活(联系CSB产品团队)

注意: 缺省您的实例处于非开放模式，对其它阿里云用户是不可见的。您可以联系产品支持团队，把实例设置成公开模式，使其它用户能在实例搜索中看到您的实例，申请对实例的使用权限。经您审批后才可以访问您的实例

## 角色与主要操作
  + 服务发布者：服务组管理, 发布服务, 发布管理
  + 服务订阅者：消费凭证管理, 订阅服务, 订阅管理
  + 系统管理员：实例管理, 用户管理

## 用户与实例、群组
  + 在云服务总线CSB中, 用户是对等的, 没有从属概念, 只有授权关系;
  + 每个用户都可以拥有属于自己的一个或多个CSB实例, 具有这些CSB实例的管理员权限;可以定义这些CSB实例之间的服务路由规则, 并控制其它用户对这些CSB实例的访问权限, 包括发布服务、订阅服务, 甚至实例管理的权限;每个用户和他所拥有的所有CSB实例, 即构成该用户的CSB租户域;
  + 云服务总线CSB有群组的概念, 对应于相对隔离的管理环境;例如企业的内部数据中心和阿里云公共云的某个地域(region)即是不同的群组;相应地, 也有CSB群组管理员的角色, 与CSB实例管理员不同, 只有群组管理员可以应用户请求创建CSB实例;例如在阿里云公共云环境中, CSB产品运维团队即是该群组的管理员;
  + 每个用户在取得某个CSB实例的访问权限后, 即可以在该实例上发布或者订阅服务;服务的发布者就是该服务的拥有者, 可以审批授权其它用户的订阅申请, 甚至授权其它用户管理该用户的某个服务组;类似的, CSB用户在这里同样是对等的, CSB只关心两个用户之间针对某个服务或服务组的授权关系, 并不关心用户的实际组织层级和隶属关系;

## 级联式服务发布
+ 云服务总线支持级联发布, 即跨CSB实例的服务发布, 也就是在一个CSB实例上接入已有服务, 而在另外一个CSB实例上开放出来, 供订阅者消费;级联链路可以跨**3个或更多节点**;
+ 要注意的是, 级联发布的链路并不是随意的, 需要实例管理员在出发节点也就是服务的接入端实例进行定义;链路规则就是指明接连链路中各个CSB实例的**先后链接关系**, 例如A接入的服务要在C上发布, 必须依次经过实例B和C;
+ 级联服务经过的CSB实例可能归属不同的用户, 即隶属不同的租户域, 如果实例管理员在链路规则中涉及到归属其他用户甚至群组的CSB实例, 就需要进行**实例间授信**;在阿里公共云上, 级联发布链路的定义和管理, 包括实例间授信操作, 都由**群组管理员**, 即CSB产品运维团队完成;

## 用户实例与授权示例
[链接](https://help.aliyun.com/document_detail/44714.html?spm=5176.doc32407.6.547.AlsFvs)

## 发布服务
1. 定义: 将后端服务在CSB实例上注册，并选定一种或多种协议开放成API
供消费者调用，同时对服务的消费做一定的访问控制
2. 核心概念
  (1). 接入服务：提供API对应的后端服务信息，让CSB能访问到这个已有的服务   
  (2). 开放服务：指明API开放的协议，以及开放的接口和后端服务接口如何对应   
  (3). 访问控制：指明API开放的策略，是否**限流**，对谁**可见**，访问是否需要**授权**
3. 步骤
  (1). 创建API分组
     + 发布API必须指定归属API组（服务组）
     + API组是业务上的原子粒度分组，每一个API都归属且仅归属一个API组
     + 可上传接口定义文件jar包(JDK 1.7 或以下)

  (2). 命名服务
     + 全名: CSB群组唯一，住校后可复用
     + 别名: 随意
     + API组: 简单分类
     + 服务说明: 可选
     + 服务版本:
         + 此选项指定的是该服务的`CSB发布版本`，而不是服务本身版本，后端调用不使用此信息
         + CSB服务版本是指该API在CSB上定义的版本
         + CSB目前不支持多版本同时激活(HTTP API调用需要指明版本号)

  (3). 选择协议
     + 可选择一个接入协议以及多个开放协议

  (4). 设定参数(手工输入或者从接口定义文件jar导入)
     + 主要设定入参和出参、错误代码等
     + 入参可选择是否在API开放，如不开放后端又需要，则需指定缺省值
     + 支持平级插入、缩进插入、支持数组、列表、集合等类型和复杂多级结构
     + 可指定模拟调用结果(用户模拟调用是不会真正访问后端，而是返回模拟结果)

  (5). 限制访问
     + 频度限制: 每秒最多调用次数
     + 授权访问: API是否不需要授权就可以访问
     + API可见域: 谁可以看到并订购消费该API

  (6). 发布服务

## 发布管理
### API列表页面
1. 生命周期
启动(已停用)、停止(已激活)、注销(未注销)
2. 服务筛选
是否显示级联服务、注销服务
3. 服务查找
服务名、服务别名、服务组名
4. 级联服务
列表中服务名以“|--”、“--”、“--|”开头的服务，其实都是级联发布的服务，分别代表当前实例为该级联的起始端（即已有服务的接入端）、接力端，和结束端

### API详情页面
+ 调用统计
+ 基本信息
+ 协议信息
+ 参数信息
+ 控制信息
+ 版本控制：选择指定版本查看，并可以激活指定版本

### API授权
发布者>我的服务菜单可看到当前用户发布的服务的订阅授权状况；服务的订阅需要发布者的审批才可以生效

## 订阅服务
1. 创建消费凭证('我的凭证'页面创建)
 + 需要消费凭证(AK/SK)来订购API
 + 凭证名称允许英文字符和“.”、“:”、“-”、“\_”四个特殊字符
 + 凭证代表服务API的消费方应用
 + 一个用户可创建多个凭证代表不同的应用或者应用组
 + 凭证更换(通常需要一个时间窗口让新旧的凭证同时生效)
     + 更新： 旧凭证还有效
     + 取代： 旧凭证将会废弃

2. 搜索查找服务
 + 通过服务名、别名、API组名查找

3. 服务订阅
 + 指定需要的QPS（每秒的访问量）
 + 指定消费凭证
 + 提交申请

## 订阅管理
### 服务状态
已激活、已停用、已注销等

### 服务筛选
已订购服务、已退订服务

### 订阅状态
初始化、已订阅、已退订
已退订: 由于用户可用多个凭证订阅同一个服务API, 因此状态是"已退订"意思是当前用户用于订阅该API的所有凭证都已退订

### 退订
整体退订(所有凭证)、单独退订

### API详情
服务详细信息、订单详细信息、服务统计信息

## 调用服务
+ HTTP API(需要SDK)
+ HSF API(不需要SDK)
+ Web Service API(?)   

[链接](https://help.aliyun.com/document_detail/42995.html?spm=5176.doc32407.6.553.i7eulJ)   
阿里云公共云上不建议使用不包含版本信息参数的调用方法

## 常见问题
[链接](https://help.aliyun.com/knowledge_detail/42985.html?spm=5176.doc42995.6.555.nfiTTn)
