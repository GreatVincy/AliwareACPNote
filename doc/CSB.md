# 概念

- 名词解释：云服务总线(Cloud Service Bus)
- 面向对象：专有云和专有域
- 实现目标：帮助企业在自己的多个系统之间, 或者与合作伙伴以及第三方的系统之间实现跨系统跨协议的服务能力互通，还提供审批授权、服务管控和计量监控等能力

# 功能示意

1. 企业内部不同架构平台的服务之间通过CSB实现互通
2. 企业内部服务开放给外部, 允许通过CSB以不同的协议同时访问
3. 企业内部通过CSB访问外部以不同协议提供的服务
4. 外部不同架构平台的服务之间通过CSB实现互通

# 产品功能

1. API服务总线

  - 协议转换(HTTP/HSF/Dubbo/Web Service)
  - 认证鉴权(接入企业账号体系)
  - 服务控制(流量控制):提供服务流量控制、黑白名单、服务路由、响应过滤

2. API管理组织

  - 服务发布(版本管理, API分类)
  - 服务授权(粒度、可见域)
  - 服务消费(调用SDK、消费计量、限量)

3. API运维监控

  - 平台日志(消费、管理、监控日志)
  - 平台监控(展示、巡检、报警)
  - 平台配置(实例、用户、用户组、角色权限管理)

# 产品优势

- 高性能稳定可靠
- 轻量级简便易用
- 跨协议开放互联
- 一站式服务管理

# 应用场景

> 云服务总线CSB可以应用于**专有云、公共云, 以及混合云**场景, 实现跨系统跨协议的服务互通;主要针对需要进行管理和控制, 包括安全授权、流量限制的系统间服务访问和对外开放场景;

> 云服务总线CSB注重互联网场景下的开放性;越来越多的情况下, 服务的提供方要面对的是更不确定、更广泛的服务消费用户群, 需要针对性地强调互通开放管理以及便捷的线性扩容能力, 而不是仅仅实现协议转换或者确定目标的以及限定用量的上下游系统之间的集成打通;

- 内部互通

  1. 一个域的应用通过另一个域的CSB实例访问其内部应用服务
  2. 两个域的CSB实例构成的桥接通道实现互通
  3. 各个域之间通过企业统一的CSB实例实现互通

- 内外互通

  1. 企业内部以及合作伙伴和第三方都可以在CSB上开放订购服务
  2. 各自的服务通过授权做访问控制(包括流量控制等)
  3. 所有开放的服务在CSB上形成由企业自主管理的综合服务集市

- 混合云、多群组

  1. 企业内部某个CSB与其在公共云上的某个VPC内的CSB通过专线互通
  2. 公共云上的多个企业VPC之间通过各自的CSB互通
  3. 每个CSB(实例)上的用户和服务由CSB实例拥有者自主管理

# 名词解释

名词       | 解释
:------- | :-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
API消费方应用 | 指直接调用CSB上开放的服务API的消费者应用
API消费方应用 | 即代表API消费方应用在CSB上订购服务和管理订购的用户
API消费凭证  | API消费方应用需要使用API消费凭证(简称凭证)来调用CSB上开放的服务API;API消费者使用凭证来订购API;凭证具体表现为一对AccessKey和SecretKey, 通常简称AK/SK, 在API调用时用来做签名信息计算, CSB接收到API调用请求时对签名信息做验证;API消费者可以创建多个API消费凭证, 每个凭证可被一个或一组API消费方应用使用, 通常可以把凭证作为API消费方应用的分组
API提供方应用 | 和消费方相对, 指接入CSB开放出服务API的提供者应用
API发布者   | 即API提供方应用在CSB上发布服务和管理服务的代表;体现为开放平台上具有发布者角色的账号
CSB实例    | 每一组CSB服务总线节点(Broker)集群被视为一个独立的CSB实例, 通常负责一个业务域内能力的对外开放, 也可以把外部的能力发布开放给业务域的内部
CSB群组    | 一个CSB群组就是多个CSB实例的集合, 这些CSB实例通过同一个CSB管理中心管理, 使用同一套用户账号系统;如何界定群组的边界取决于实际业务需求以及网络拓扑限制, 而其中CSB管控中心与CSB实例的部署模式也应根据具体网络拓扑限制确定
服务接入     | 对CSB来说, 或者说将服务接入到CSB上, 指的是在CSB上注册这个服务并且提供足够的信息让CSB可以访问这个已有的服务;例如要接入一个RESTful服务, 需要提供这个服务的基础URL或称端点, 要使用的HTTP方法等信息
服务开放     | 对CSB来说, 服务在CSB上开放就是把一个已接入的服务在某个CSB上提供对应的API调用入口, 可以用各种协议(包括原协议)来访问这个服务API;注意API的发布都在特定CSB实例上
服务授权     | API的发布者赋予API消费方应用使用指定API消费凭证来调用某个API 的权限, 就是授权;授权除了定性的允许、禁止之外, 还可以包含更广泛的限制如访问频度控制、优先级等等
服务组      | 服务组(API组)是业务上的原子粒度分组, 每一个API都归属且仅归属一个API组;也就是说, 在发布新的API时, 必须指定其所属的服务组;API组在API数量少时可视作简单分类, 在数量多时通常需要更多层次结构的分类目录树, 这个特性将在后续版本推出

# 角色与主要操作

- 服务发布者：服务组管理, 发布服务, 发布管理
- 服务订阅者：消费凭证管理, 订阅服务, 订阅管理
- 系统管理员：实例管理, 用户管理

# 用户、实例、群组

- 在 CSB 中，用户是对等的，没有**从属**概念，只有**授权**关系。
- 每个用户都可以拥有属于自己的一个或多个 CSB 实例，具有这些 CSB的**实例的管理员**权限。可以控制其它用户对这些 CSB 实例的访问使用权限，即在该实例上**发布服务、订阅服务，甚至实例管理**的权限。每个用户和**他所拥有的**所有 CSB 实例，即构成该用户的 CSB**租户**域。
- 用户在取得某个 CSB 实例的访问使用权限后，即可以在该实例上发布或者订阅服务。服务的发布者就是该服务的拥有者，可以审批授权其它用户对该服务的订阅申请。

  - 实例拥有者 控制其他用户对**实例的访问**使用权限（参考实例发布与访问授权）
  - 服务拥有者 控制其他用户对**服务的订阅访问**权限（参考服务发布与访问授权）

- 云服务总线 CSB 有群组的概念，对应于**相对隔离的管理环境**。例如企业的内部数据中心和阿里云公共云的某个地域（region）即是不同的群组。相应地，也有 CSB**群组管理员**的角色，与 CSB 实例管理员不同，只有群组管理员可以应用户请求**创建 CSB 实例**。例如在阿里云公共云环境中，CSB 产品支持团队即是该群组的管理员。

# 级联式服务发布

- 针对复杂多环境多归属打通场景，云服务总线提供级联发布管理机制，即跨 CSB 实例的服务发布，也就是在一个 CSB 实例上接入已有服务，而在另外一个 CSB 实例上开放出来，供订阅者消费。级联链路可以跨 2 个或更多 CSB 实例，这些 CSB 实例可以**归属不同的用户**，甚至**位于不同的 CSB 群组内**。
- 要注意的是，级联发布的链路并不是随意的，需要**群组管理员**定义有方向的连通链路，指明连通链路中各个 CSB 实例的先后链接关系。例如 CSB 实例 A 上接入的服务通过实例 B 作为中转，最终在 CSB 实例 C 上开放，就构成了一条经由实例 A 到 B 到 C 的 级联链路。
- 级联服务经过的 CSB 实例在级联链路方向上需要进行实例间**授信**。在**公共云**上，级联链路的**定义和管理**，包括实例间**授信**操作，都由**群组管理员**，即 CSB 产品支持团队完成。

# 公测开通指南

1. 申请开通 CSB 公测资格
2. 提交 CSB 实例创建申请
3. 准备 ECS 主机资源（（至少一台）目前只支持杭州机器(华东１)，建议 2 核 4G 内存的 ECS）
4. 实例部署激活(联系CSB产品团队)

注意: 缺省您的实例处于**非开放模式**，对其它阿里云用户是不可见的。您可以联系产品支持团队，把实例设置成公开模式，使其它用户能在实例搜索中看到您的实例，申请对实例的使用权限。经您审批后才可以访问您的实例

# 实例发布与访问授权

1. 已开通 CSB 服务的阿里云用户，可以申请创建归属用户的 CSB 独占实例
2. CSB 用户可以申请使用他人的实例，需要拥有者审批授权。被申请的实例只有处于公开模式时，才可以被搜索和申请，否则就只能由实例的拥有者主动授权给其它用户使用该实例
3. 实例的拥有和授权

  - 一个 CSB 实例就是一个单独的服务开放平台，已授权可访问它的用户能够在其上发布和订阅服务。
  - CSB 实例的拥有者可以管理对其他用户的授权，即审批其他用户对该实例的访问申请，是否允许访问实例，进行服务的发布和订阅。
  - CSB 缺省是不公开的，即对其他阿里云用户是不可见的。您可以联系产品支持团队，把您的实例设置成公开模式，使其它用户能在实例搜索中看到您的实例。其他用户申请该实例的使用权限，由您审批后才可以访问您的实例。

# 服务发布与访问授权

1. 服务发布与审核

  - 用户在取得某个 CSB 实例的访问使用权限后，可以在该实例上发布服务，成为该服务的发布者
  - 服务发布有时也需要控制管理，CSB 实例的拥有者可以指定该实例上的服务发布审核人，可以是实例拥有者自己，也可以是已授权可访问该实例的普通用户。指定服务发布审核人后，所有在该实例上的服务发布都要经过该审核人的批准后才会生效

2. 服务订阅与授权

  - 用户在取得某个 CSB 实例的访问使用权限后，可以在该实例上订阅服务。如果被订阅的服务不是缺省自动授权的模式，该订阅需要服务发布者审核批准后才会生效
  - 服务消费者使用消费凭证订阅服务 API，经服务发布者审批通过后订阅生效，之后服务消费者也可以选择退订以及重新订阅该 API，重新订阅时**仍需要服务发布者审批**。
  - 订阅生效后，服务消费方应用以订阅所用的**消费凭证**来访问服务 API，CSB 提供针对不同开放协议的客户端 SDK，用户也可以按 CSB 的签名规范自行实现特定语言的版本，详情可以参考 SDK 的说明和使用。
  - 服务消费者可以拥有多个消费凭证，一个凭证可以用来**订阅多个服务** API，也可以用多个凭证来订阅同一个服务 API(分组)，每个凭证都可以单独更新，凭证更新时允许新旧凭证信息**同时**生效，待消费方应用使用新凭证信息后，旧的凭证信息作废。

3. CSB服务调用提供(按顺序) + 验签/鉴权/管控

# 实例管理

- 实例状态包括：获准使用、拥有和审批中。

  - 获准使用：其他用户创建的，当前用户申请并审批通过，可以使用的实例。
  - 拥有：当前用户创建的实例。可以对该实例进行服务发布审批设置，也可以授权其他用户使用该实例。
  - 审批中：当前用户已经申请使用，但在 审批中 的实例。

- 实例名字：只支持英文及数字，并且 实例名字要在整个 CSB 群组内唯一

- 操作

  - 单击 实例名称 或操作列的 查看实例，查看实例详细信息。
  - 单击 服务发布审批设置，设置在实例中发布服务的审批方式。
  - 单击 授权用户，给其他用户授权，使其具有该实例的使用权限。

- 创建实例

  - 用户可以通过 CSB 控制台创建一个或多个 CSB 实例，具有这些实例的管理员权限。可以控制其他用户对这些实例的 访问使用权限。

## 设置审批级别。

- 不需要审批：即该实例上发布的服务，直接处于激活状态，不需要审批。
- 一级审批：即该实例上发布的服务，默认为待审批状态，需要指定的一级审批人审批后才处于激活状态。
- 二级审批：即该实例上发布的服务，默认为待审批状态，需要经过指定的一级审批人和二级审批人审批后才处于激活状态。

## 设置审批人。

- 审批人只能是当前实例的拥有者或者使用者。
- 如果是两级审批，则第一级审批人和第二级审批人不能是同一个人。
- 注意: 审批级别在变更前，应确保本实例上发布的待审批服务已经审批处理过，否则，这些服务可能无法正常变成可用状态。

## 授权用户

- 实例的拥有者，可以主动为其他用户授权，使其具有该实例的使用权限。
- 在实例列表页面中拥有的某个实例操作列，单击 授权用户。
- 在授权实例到指定用户对话框中，输入 被授权用户的登录名，单击 保存

## 申请实例

- 用户可以申请某个实例的访问权限，申请成功后，即可在该实例上发布或订阅服务。
- 在 CSB 控制台 左侧导航栏中，单击 实例搜索。
- 选择想要申请的实例，在该实例的操作列中单击 申请。

# 服务组管理

- 服务组（API 组）是业务上的原子粒度分组，每一个服务（API）都归属且仅归属一个服务组。也就是说，在发布新的服务时，必须指定其所属的服务组
- (编辑)服务组名称不可修改，其它项可以按照实际情况修改
- 停止该服务组后，所有属于这个服务组的服务都会停止。
- 启动服务组后，所有属于这个服务组的服务都会启动。
- 服务组一旦删除，将不可恢复。所以在删除前，务必确认是否不再需要该服务组。
- 如果该服务组下有服务，是不能删除的，会弹出错误提示。删除服务组，需要先将其下所有服务删除。

# 发布服务

1. 定义: 将后端服务在CSB实例上注册，并选定一种或多种协议开放成API 供消费者调用，同时对服务的消费做一定的访问控制
2. 核心概念 (1). 接入服务：提供API对应的后端服务信息，让CSB能访问到这个已有的服务<br>
  (2). 开放服务：指明API开放的协议，以及开放的接口和后端服务接口如何对应(可开放**多个**协议)<br>
  (3). 访问控制：指明API开放的策略，是否**限流**，对谁**可见**，访问是否需要**授权** (4). CSB 控制台的新版发布功能支持服务路由的发布，所以建议使用新版来发布服务；同时为了保持向前兼容(例如，后端 Broker 不能及时升级)
3. 步骤 (1). 创建API分组

  - 发布API必须指定归属API组（服务组）
  - API组是业务上的原子粒度分组，每一个API都归属且仅归属一个API组
  - 可上传接口定义文件jar包(JDK 1.7 或以下)

  (2). 命名服务

  - 全名: 新版 ? 不可以为中文，只能是数字,(全名+版本号)在 CSB 实例上是唯一的 : CSB群组唯一，注销后可复用
  - 版本
  - 别名: 随意
  - API组: 简单分类
  - 服务说明: 可选
  - 归属: 可选
  - 服务版本:

    - 此选项指定的是该服务的`CSB发布版本`，而不是服务本身版本，后端调用不使用此信息
    - CSB服务版本是指该API在CSB上定义的版本
    - CSB目前不支持多版本同时激活(HTTP API调用需要指明版本号)

  - (全名+版本号)在 CSB 实例上是唯一的。服务全名相同但版本号不同的服务，发布时要确保：在该实例下其他的同服务全名的服务都已经处于注销状态。

  - 同一个服务名的两个版本可以视为两个服务，即客户端调用的时候需要指定调用的服务名+版本号

  (3). 选择协议(新版旧版差异较大,这里是旧版)

  - 可选择一个接入协议以及多个开放协议
  - 开放的协议可以多选，针对不同的接入协议类型，CSB支持的可开放协议类型是有限制的

  (4). 设定参数(手工输入或者从接口定义文件jar导入)(新版旧版差异较大,这里是旧版)

  - 主要设定入参和出参、错误代码等
  - 入参可选择是否在API开放，如不开放后端又需要，则需指定缺省值
  - 支持平级插入、缩进插入、支持数组、列表、集合等类型和复杂多级结构
  - 可指定模拟调用结果(用户模拟调用是不会真正访问后端，而是返回模拟结果)

  (5). 限制访问

  - 频度限制: 每秒最多调用次数
  - 授权访问: API是否不需要授权就可以访问
  - API可见域: 谁可以看到并订购消费该API

  (6). 发布服务

4. 开放协议注意:

  - 对于直接路由，开放协议是由所选择的接入协议决定，这与旧版的服务发布完全相同。
  - 对于基于内容的路由，开放协议目前只支持 Restful 协议类型。

5. 旧版协议支持 ![xx.png](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/58804/cn_zh/1504169287235/sp-scenario-protocols.png)

新版: <https://help.aliyun.com/document_detail/58436.html?spm=5176.doc58604.6.552.jkrFJo><br>
旧版: <https://help.aliyun.com/document_detail/42989.html?spm=5176.doc58436.2.3.YKhPxr>

## 命名规范

- 服务组名称：允许使用中英文字符、数字及- _ 不允许有空格
- 服务全名：不可以为中文，只能使用数字，字母或 -
- 服务版本：不可以为中文, 只能使用数字，字母或 .
- 服务发布的参数名：只能使用数字，字母或 _

## 级联

级联和透传貌似只支持HSF和WebService

# 发布管理

## API列表页面

1. 生命周期

  - 激活 (启动)
  - 停止
  - 待审批 (待一级审批)
  - 审批驳回 (一级审批驳回)
  - 待二级审批
  - 二级审批驳回
  - 注销

2. 状态切换

  - 服务可以在停止和启动两种状态间切换，但是一旦注销则不可以再启动。
  - 服务注销是服务生命周期的最终状态，意味着不可以对该服务进行变更，启动、停止和订购操作。

3. 服务筛选 是否显示级联服务、注销服务

4. 服务查找 服务名、服务别名、服务组名

5. 级联服务 列表中服务名以"|--"、"--"、"--|"开头的服务，其实都是级联发布的服务，分别代表当前实例为该级联的起始端（即已有服务的接入端）、接力端，和结束端

## 黑/白名单管理

- IP 地址的添加规则是：

  - 可以添加某个具体 IP 地址，如: 192.168.1.1，也可以设置带有掩码的的 IP 地址段， 如: 192.168.1.1/24 ("/" 后面的取值是1~32, 代表子网掩码的位数，24表示掩码为:255.255.255.0)
  - 每行记录一条 IP 地址，换行分隔。

- 说明：

  - 在白名单中添加某个调用者的 IP 后，该调用者不做鉴权即可访问该服务。
  - 在黑名单中添加某个调用者的 IP 后，该调用者不能访问该服务。
  - 如果某个调用者的 IP 即被添加到白名单，又在黑名单里，则黑名单优先，即拒绝访问该服务。

- 单击 配置，设置该服务的默认访问策略。

  - 对于既不在白名单里，也不在黑名单里的 IP 地址，通过 表示无需鉴权即可访问，拒绝 代表该服务默认不允许任何 IP 地址访问。

- 访问限制

  - 如果开启公开访问，即允许不授权访问，使用者可以直接使用任意合法的 Access Key ID/Access Key Secret 访问服务。
  - 如果关闭公开访问，即必须经过授权才能访问，使用者必须先订阅(提交申请)，所有者审批通过后才能正常调用。

## API详情页面

- 调用统计
- 基本信息
- 协议信息
- 参数信息
- 控制信息
- 版本控制：选择指定版本查看，并可以激活指定版本

## API授权

发布者>我的服务菜单可看到当前用户发布的服务的订阅授权状况；服务的订阅需要发布者的审批才可以生效

# 订阅服务

1. 创建消费凭证('我的凭证'页面创建)

  - 需要消费凭证(AK/SK)来订购API
  - 凭证名称允许英文字符和`"."、":"、"-"、"_"`四个特殊字符
  - 凭证代表服务API的消费方应用
  - 一个用户可创建多个凭证代表不同的应用或者应用组
  - 凭证更换(通常需要一个时间窗口让新旧的凭证同时生效)

    - 更新： 旧凭证还有效
    - 取代： 旧凭证将会废弃

2. 搜索查找服务

  - 通过服务名、别名、API组名查找

3. 服务订阅

  - 指定希望的的QPS（每秒的访问量，必选）和QPH(每秒访问量，可选)，最终值由提供方决定
  - 指定消费凭证
  - 绑定IP(白名单，可选)
  - 提交申请

# 订阅管理

## 服务状态

已激活、已停用、已注销等

## 服务筛选

已订购服务、已退订服务

## 订阅状态

初始化、已订阅、已退订 已退订: 由于用户可用多个凭证订阅同一个服务API, 因此状态是"已退订"意思是当前用户用于订阅该API的所有凭证都已退订

## 退订

整体退订(所有凭证)、单独退订

## API详情

服务详细信息、订单详细信息、服务统计信息

# 调用服务

- HTTP API(需要SDK)
- HSF API(不需要SDK，可指定CSB服务地址)
- Web Service API(需要SDK)

- 注:

  - 服务消费者,订阅者，发布者可以互不相同或者都相同或者其中两个相同
  - 阿里云公共云上不建议使用不包含版本信息参数的调用方法

- 调用统计

  - 服务组
  - 服务
  - 凭证
  - 单一订阅

# 常见问题

- CSB 处理服务请求的时延有多久？

  - CSB 本身处理服务请求的时间很短，一般在2ms左右，整体的延迟主要由网络延迟和后端服务自身的耗时决定。

- 名称

  - CSB 中的"实例名"、"服务名"、"凭证名" 三个名字不支持中文，别名可以包括中文；如果不小心含有中文，会得到错误

- CSB 是否支持调用统计?

  - 公有云版本尚未支持调用统计，专有云版本已经支持。CSB 服务调用日志保存在 ECS 的 CSB 服务器上/home/admin/cloud-gateway/logs/invoke.log
